%
% Alternate Outer Theme based on an idea by the Intitute of Telematics
%
% Declaration of Options, definition of specific commands the the design elements,
% such as headline, footline and frametitle
%
% Published under Beeware-License:
%
% THE BEER-WARE LICENSE (Rev. 42):
% Ronny Bergmann <bergmann@mathematik.uni-kl.de> wrote this file. As long as
% you retain this notice you can do whatever you want with this stuff. If we
% meet some day, and you think this stuff is worth it, you can buy me a beer
% or coffee in return.
%
%
% Actually Ronny Bergmann wrote a template file for the TUK. Patrick Mischke 
% <mischke@rptu.de> rewrote it for the RPTU. I don't drink beer or coffee, 
% but I'm sure you can buy me something nice as well if you feel like it. 
%
\ProvidesPackage{beamerouterthemeRPTU}[2022/01/10 v1.0 beamer theme in the corporate design of the University of Kaiserslautern-Landau]%
\makeatletter%
%
\newlength{\footlineheight}%
\setlength{\footlineheight}{0.037\paperheight}%
\newlength{\framenumberlength}%
\setlength{\framenumberlength}{\widthof{\hspace*{1em}\inserttotalframenumber\iftukl@displayTotalFrameNumber/\inserttotalframenumber\fi}}%
\defbeamertemplate*{footline}{RPTU}%
{%
	\leavevmode%
	\ifrptu@coloredbackground
	\begin{beamercolorbox}[wd=\paperwidth,ht=\footlineheight,dp=1\footlineheight,left]{palette tertiary colored}%
	\else
	\begin{beamercolorbox}[wd=\paperwidth,ht=\footlineheight,dp=1\footlineheight,left]{palette tertiary}%
		\fi
		% Seitenzahl
		% Damit die Fußzeile nicht springt, wenn die Seitenzahl länger wird (von 9/x auf 10/x), reservieren wir Platz für alles. 
		\parbox{\framenumberlength}{
			\begin{flushright}%
				\iftukl@reduceTotalFrameNumber%fancy&still useless reduction ;)
					\pgfmathtruncatemacro{\numerator}{%
						\insertframenumber/gcd(\insertframenumber,\inserttotalframenumber)}%
					\pgfmathtruncatemacro{\denominator}{%
						\inserttotalframenumber/gcd(\insertframenumber,\inserttotalframenumber)}%
					\ifnum\denominator=1%
						\numerator%
					\else%
						\numerator/\denominator%
					\fi%
				\else%
					\textbf{%
						\insertframenumber{}\strut%
						\iftukl@displayTotalFrameNumber%
							/\inserttotalframenumber%
						\fi%
					}%
				\fi%
			\end{flushright}%
		}%
		% currently we only have the options "centered" and everything else maps to the default ("left")
		\ifthenelse{\equal{\rptufootalignment}{centered}}{\def\footspacer{\hfill}}{\def\footspacer{\hspace*{1em}}}%
		% We want to have equal spacing between date, title, author, etc of all existing stuff. 
		% Therefore we only insert \hfill for non-empty stuff. 
		% Datum
		\setbox0=\hbox{\insertshortdate}\ifdim\wd0>0pt%
			\footspacer%
			\usebeamerfont{date in head/foot}\insertshortdate{}%
		\fi%
		% Autor
		\setbox0=\hbox{\insertshortauthor}\ifdim\wd0>0pt%
			\footspacer%
			\usebeamerfont{author in head/foot}\insertshortauthor%
		\fi%
		% Titel
		\setbox0=\hbox{\insertshorttitle}\ifdim\wd0>0pt%
			\footspacer%
			\usebeamerfont{title in head/foot}\insertshorttitle%
		\fi%
		% Logo
		\hfill%
		\raisebox{-.35\height}{\resizebox{!}{.7\footlineheight}{\begin{tikzpicture}[rotate=180,xscale=-1]%
					\fill svg {%
							M21,218h60.8c11.5,0,20.9,3.7,28.4,11.1c7.4,7.4,11.1,16.5,11.1,27.4c0,4.7-0.7,9.1-2,13.2c-1.4,4.1-3,7.4-5.1,9.8			c-2,2.4-4.1,4.7-6.1,6.4c-2,1.7-3.7,3-5.1,3.7l-2,1l24.7,44.2H99.3L77,294H46v40.9H21L21,218L21,218z M92.2,245			c-3-3-6.8-4.4-11.1-4.4H46v30.7h35.1c4.4,0,8.1-1.4,11.1-4.4c3-3,4.4-6.4,4.4-10.8C96.6,251.8,95.3,248,92.2,245%
						};%
					\fill svg {%
							M202.3,218c11.8,0,21.6,3.7,29.4,11.1c7.8,7.4,11.8,16.9,11.8,28c0,11.1-4.1,20.3-11.8,28c-7.8,7.4-17.6,11.1-29.4,11.1  	h-38.5v38.5h-24.7V218.3L202.3,218z M163.8,240.6V274h37.5c5.1,0,9.1-1.7,12.5-4.7c3.4-3,5.1-7.1,5.1-11.8c0-4.7-1.7-8.8-5.1-11.8	c-3.4-3.4-7.4-4.7-12.5-4.7h-37.5V240.6z		%
						};%
					\fill svg {%
							M470.1,286.8V218h-24.6v68.7c0,7.7-2.3,14.2-7.4,19.6c-2.3,2.3-5.1,4.4-7.7,5.7c-0.6,0.3-0.7,0.3-1.4,0.7			c-3.7,2-6.4,5.7-6.4,10.5c0,6.4,5.1,11.4,11.4,11.4c1,0,2.9-0.4,4.4-1c6.4-2.3,12.5-6.1,17.5-11.1			C465.4,312.7,470.1,300.9,470.1,286.8%
						};%
					\fill svg {%
							M365.9,286.8c0,14.1,4.7,25.9,14.2,35.7c5.1,5.1,11.1,8.8,17.5,11.1c1.5,0.6,3.3,1,4.4,1c6.4,0,11.4-5,11.4-11.4			c0-4.7-2.7-8.4-6.4-10.5c-0.6-0.3-0.8-0.4-1.4-0.7c-2.7-1.4-5.4-3.4-7.7-5.7c-5.1-5.4-7.4-11.8-7.4-19.6V218h-24.6L365.9,286.8%
						};%
					\fill svg {%
							M352.3,218 L352.3,240.6 L312.4,240.6 L312.4,334.8 L287.8,334.8 L287.8,240.6 L247.9,240.6 L247.9,218%
						};%
				\end{tikzpicture}}}%
		\hspace*{2em}\hspace*{-\fill}% there is an automatic \hfill on the right, which we dont want as we right-align the logo
	\end{beamercolorbox}%
}%
%
%
%
\newlength{\headlineheight}%
\iftukl@displayNavigation%
	\setlength{\headlineheight}{0.037\paperheight}%
\else%
	\setlength{\headlineheight}{0.018\paperheight}%
\fi%
%
%
% Use signet U for mini frame counter instead of boring circles. 
% signet U needs to be a bit wider than circles, so we make the boxsize larger. 
\setlength{\beamer@boxsize}{.2cm}
\defbeamertemplate*{mini frame}{RPTU}
{%
	\ifrptu@coloredbackground%
	\begin{beamercolorbox}{navigation symbols colored}%
	\else%
	\begin{beamercolorbox}{navigation symbols}%
		\fi%
		\resizebox{!}{.9\beamer@boxsize}{\begin{tikzpicture}[rotate=180,xscale=-1]%
				\fill svg {%
						M376.5,276.6v-167h-59.8v167c0,18.8-5.7,34.4-18,47.5c-5.7,5.7-12.3,10.6-18.8,13.9c-1.4,0.7-1.8,0.8-3.3,1.6			c-9,4.9-15.6,13.9-15.6,25.4c0,15.6,12.3,27.8,27.8,27.8c2.5,0,7-0.9,10.6-2.4c15.6-5.7,30.3-14.7,42.6-27			C365,339.6,376.5,310.9,376.5,276.6%
					};%
				\fill svg {%
						M123.4,276.6c0,34.3,11.5,63,34.5,86.8c12.3,12.3,27,21.3,42.6,27c3.6,1.5,8.1,2.4,10.6,2.4c15.5,0,27.8-12.2,27.8-27.8			c0-11.5-6.6-20.5-15.6-25.4c-1.5-0.8-1.9-0.9-3.3-1.6c-6.5-3.3-13.1-8.2-18.8-13.9c-12.3-13.1-18-28.7-18-47.5v-167h-59.8V276.6%
					};%
			\end{tikzpicture}}%
	\end{beamercolorbox}%
}%
\defbeamertemplate*{mini frame in current subsection}{RPTU}%
{%
	%
	\ifrptu@coloredbackground%
	\begin{beamercolorbox}{navigation symbols colored}%
	\else%
	\begin{beamercolorbox}{navigation symbols}%
		\fi%
		\resizebox{!}{.9\beamer@boxsize}{\begin{tikzpicture}[rotate=180,xscale=-1]%
				\draw svg {%
						M376.5,276.6v-167h-59.8v167c0,18.8-5.7,34.4-18,47.5c-5.7,5.7-12.3,10.6-18.8,13.9c-1.4,0.7-1.8,0.8-3.3,1.6			c-9,4.9-15.6,13.9-15.6,25.4c0,15.6,12.3,27.8,27.8,27.8c2.5,0,7-0.9,10.6-2.4c15.6-5.7,30.3-14.7,42.6-27			C365,339.6,376.5,310.9,376.5,276.6%
					};%
				\draw svg {%
						M123.4,276.6c0,34.3,11.5,63,34.5,86.8c12.3,12.3,27,21.3,42.6,27c3.6,1.5,8.1,2.4,10.6,2.4c15.5,0,27.8-12.2,27.8-27.8			c0-11.5-6.6-20.5-15.6-25.4c-1.5-0.8-1.9-0.9-3.3-1.6c-6.5-3.3-13.1-8.2-18.8-13.9c-12.3-13.1-18-28.7-18-47.5v-167h-59.8V276.6%
					};%
			\end{tikzpicture}}%
	\end{beamercolorbox}%
}%
%
% Wir brauchen eine Möglichkeit, zu messen, wie groß das Logo ist, um dafür Platz zu schaffen.
\newsavebox{\logobox}%
\newlength{\logowidth}%
\newlength{\logoheight}%
% Wir können hier das Logo noch nicht einfügen, da es noch nicht per \logo{...} vom Nutzer gesetzt wurde...
% 
\defbeamertemplate*{headline}{RPTU}
{
	% Sieht aus, als hätten wir keine Design Headline mehr? Folien beginnen direkt mit Inhalt.
	% ich mag die nav-bar, also packe ich sie einfach nach oben. Da ist bestimmt Platz. 
	% Alternativ könnte man \insertverticalnavigation{} nutzen, dafür muss man dann auch
	% \defbeamertemplate*{section in sidebar}{RPTU} bzw. {section in sidebar shaded} definieren)
	% 
	% Logo vorbereiten und Breite messen 
	\sbox{\logobox}{\insertlogo}%
	\global\logowidth=\wd\logobox%
	\global\logoheight=\ht\logobox%
	%
	\leavevmode%
	\raggedleft%
	\ifrptu@coloredbackground%
	\begin{beamercolorbox}[leftskip=0pt,rightskip=0pt,wd=\paperwidth, ht=\headlineheight, center]{palette secondary colored}%
	\else%
	\begin{beamercolorbox}[leftskip=0pt,rightskip=0pt,wd=\paperwidth, ht=\headlineheight, center]{palette secondary}%
		\fi%
		\iftukl@displayNavigation%
			\ifnum\c@framenumber=1%
				\relax
			\else%
				\insertnavigation{\dimexpr\paperwidth-\logowidth-2pt}
			\fi%
		\else
			\hspace*{\dimexpr\paperwidth-\logowidth-2pt}
		\fi
		\hfill
		\smash{\raisebox{\dimexpr\headlineheight-1\logoheight}{\usebox{\logobox}}}
	\end{beamercolorbox}
	\strut
	\par
}%
%
\defbeamertemplate*{sidebar right}{RPTU}%
{%
	% Usually the logo would be placed on the bottom of
	% the right sidebar. We don't want this. 
	% just in case someone actually likes those navigation symbols, (buttons for next/previous slide), we keep them.
	\vfill%
	\llap{\usebeamertemplate***{navigation symbols}\hskip0.1cm}%
	\vskip2pt%
}%
%
% Plain Style for the titlepage
%
\defbeamertemplate{footline}{RPTUplain}{}
\defbeamertemplate{headline}{RPTUplain}
{
	\leavevmode%
	\vspace{3\baselineskip}
	\strut
	\par
}%
%
\newif\ifrptu@coloredbackground
\rptu@coloredbackgroundfalse
\define@key{beamerframe}{coloredbackground}[true]{%
	\rptu@coloredbackgroundtrue%
	\begingroup
	\setbeamertemplate{background canvas}[coloredBackground][secondaryrptuthemecolor]
	\setbeamercolor*{section in head/foot}{use=section in head/foot colored}
	\usebeamercolor[fg]{normal text colored}
}% 
% unset our option, so it does not stick around forever but is limited to 1 frame
\pretocmd{\beamer@reseteecodes}{%
	\ifrptu@coloredbackground
		\endgroup
		\rptu@coloredbackgroundfalse
		\setbeamertemplate{background canvas}[default]
		\setbeamercolor*{section in head/foot}{use=section in head/foot default}
		\usebeamercolor[fg]{normal text}
	\fi
}{}{}

\newlength{\dekolinelengthbelowframetitle}
\setlength{\dekolinelengthbelowframetitle}{.7cm}

\defbeamertemplate*{frametitle}{RPTU}
{
	\nointerlineskip%
	\ifrptu@coloredbackground%
	\begin{beamercolorbox}[wd=\paperwidth, ignorebg, leftskip=.6cm, rightskip=\dimexpr.6cm+\logowidth, vmode]{frametitle colored}%
	\else%
	\begin{beamercolorbox}[wd=\paperwidth, ignorebg, leftskip=.6cm, rightskip=\dimexpr.6cm+\logowidth, vmode]{frametitle}%
		\fi%
		\par{\usebeamerfont*{frametitle}\insertframetitle\strut\par}%
		\ifx\insertframesubtitle\@empty%
			\vskip-.5ex%
			\rule{\dekolinelengthbelowframetitle}{.7pt}%
			\strut\par%
			\vspace{-.3\baselineskip}%
		\else%
			\vskip-.25ex%
			\par{\usebeamerfont*{framesubtitle}{\usebeamercolor[fg]{framesubtitle}\insertframesubtitle}\strut\par}%
			\vskip-.5ex%
			\par\rule{\dekolinelengthbelowframetitle}{.7pt}\strut\par%
		\fi%
		\vskip-.5ex%
	\end{beamercolorbox}%
	\nointerlineskip%
}
\setbeamersize{text margin left=2em,text margin right=2em}
%
\defbeamertemplate*{background canvas}{coloredBackgroundWithLogo}[1][white]{%
	\begin{tikzpicture}
		\useasboundingbox (0,0) rectangle (\the\paperwidth,\the\paperheight);
		\fill[fill=#1] (0,0) rectangle (\the\paperwidth,\the\paperheight);
		\node at (.45\paperwidth,1) {
			\begin{beamercolorbox}[wd=.9\paperwidth,ht=\footlineheight,right]{logo titlepage}%
				\vspace*{-.2\footlineheight}\resizebox{!}{1.1cm}{\fullrptulogo}
			\end{beamercolorbox}
		};
	\end{tikzpicture}
}
%
\defbeamertemplate*{background canvas}{coloredBackgroundWithLogoAndSignet}[1][white]{%
	\begin{tikzpicture}
		\useasboundingbox (0,0) rectangle (\the\paperwidth,\the\paperheight);
		\fill[fill=#1] (0,0) rectangle (\the\paperwidth,\the\paperheight);
		\node at (.45\paperwidth,1) {
			\begin{beamercolorbox}[wd=.9\paperwidth,ht=\footlineheight,right]{logo titlepage}%
				\vspace*{-.2\footlineheight}\resizebox{!}{1.1cm}{\fullrptulogo}
			\end{beamercolorbox}
		};
		\node at (.7\paperwidth,.7\paperheight) {
			\begin{beamercolorbox}[center]{signet titlepage two}%
				\resizebox{!}{.45\paperheight}{\signetu}
			\end{beamercolorbox}
		};
		\node at (.7\paperwidth-.17\paperheight,.55\paperheight) {
			\begin{beamercolorbox}[center]{signet titlepage one}%
				\resizebox{!}{.35\paperheight}{\signetu}
			\end{beamercolorbox}
		};
	\end{tikzpicture}
}
%
%
\defbeamertemplate*{background canvas}{coloredBackground}[1][white]{%
	\begin{tikzpicture}
		\useasboundingbox (0,0) rectangle (\the\paperwidth,\the\paperheight);
		\fill[fill=#1] (0,0) rectangle (\the\paperwidth,\the\paperheight);
	\end{tikzpicture}
}
%
%
\renewcommand{\maketitle}[0]
{%
	\setbeamertemplate{headline}[RPTUplain]%
	\setbeamertemplate{footline}[RPTUplain]%
	\ifrptu@signetUonTitle
		\setbeamertemplate{title page}[RPTUsignet]
		\setbeamertemplate{background canvas}[coloredBackgroundWithLogoAndSignet][secondaryrptuthemecolor]
	\else
		\setbeamertemplate{title page}[RPTU]
		\setbeamertemplate{background canvas}[coloredBackgroundWithLogo][secondaryrptuthemecolor]
	\fi
	\ifbeamer@inframe%
		\vspace{1.3ex}%
		\titlepage%
	\else%
		\frame[t]{\titlepage}%
	\fi%
	\setbeamertemplate{background canvas}[default]
	\setbeamertemplate{headline}[RPTU]%
	\setbeamertemplate{footline}[RPTU]%
}
\mode<all>
\makeatother
